---
- name: DISA STIG Compliance Implementation
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true
  vars:
    stig_disruption_high: "{{ stig_disruption_high | default(false) }}"
    stig_cat1_patch: "{{ stig_cat1_patch | default(true) }}"
    stig_cat2_patch: "{{ stig_cat2_patch | default(true) }}"
    stig_cat3_patch: "{{ stig_cat3_patch | default(false) }}"
    stig_skip_reboot: "{{ stig_skip_reboot | default(true) }}"
    stig_run_audit: "{{ stig_run_audit | default(false) }}"
    stig_audit_results: []
    stig_findings: []
    stig_session_timestamp: "{{ ansible_date_time.iso8601 }}"
    dod_warning_banner: "You are accessing a U.S. Government (USG) Information System (IS) that is\nprovided for USG-authorized use only.\n\nBy using this IS (which includes any device
      attached to this IS), you\nconsent to the following conditions:\n\n- The USG routinely intercepts and monitors communications on this IS for\n  purposes including, but not limited
      to, penetration testing, COMSEC\n  monitoring, network operations and defense, personnel misconduct (PM),\n  law enforcement (LE), and counterintelligence (CI) investigations.\n
      \n- At any time, the USG may inspect and seize data stored on this IS.\n\n- Communications using, or data stored on, this IS are not private, are\n  subject to routine monitoring,
      interception, and search, and may be\n  disclosed or used for any USG-authorized purpose.\n\n- This IS includes security measures (e.g., authentication and access\n  controls)
      to protect USG interests -- not for your personal benefit or\n  privacy.\n\n- Notwithstanding the above, using this IS does not constitute consent to\n  PM, LE or CI investigative
      searching or monitoring of the content of\n  privileged communications, or work product, related to personal\n  representation or services by attorneys, psychotherapists, or clergy,
      and\n  their assistants. Such communications and work product are private and\n  confidential. See User Agreement for details.\n"
  pre_tasks:
    - name: Validate STIG compliance prerequisites
      tags:
        - validation
      ansible.builtin.assert:
        that:
        - ansible_os_family in ['Debian', 'RedHat']
        - ansible_distribution_major_version is version('7', '>=')
        fail_msg: "Unsupported OS family or version: {{ ansible_os_family }} {{ ansible_distribution_major_version }}"
    - name: Create STIG audit directory structure
      tags:
        - logging
      loop:
        - audit
        - findings
        - remediation
        - reports
      ansible.builtin.file:
        path: /var/log/stig-audit/{{ item }}
        state: directory
        mode: "0750"
        owner: root
        group: root
    - name: Create STIG audit rules file
      tags:
        - audit
      ansible.builtin.file:
        path: /etc/audit/rules.d/99-stig-audit.rules
        state: touch
        mode: "0640"
        owner: root
        group: root
  tasks:
    - name: Update system packages (prerequisite)
      tags:
        - updates
        - packages
        - skip_ansible_lint
      register: stig_system_update
      ansible.builtin.package:
        name: "*"
        state: latest
        update_cache: true
    - name: V-238200 - Install session lock capability (vlock)
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - session
        - V-238200
      register: stig_v238200
      ansible.builtin.package:
        name: vlock
        state: present
    - name: V-238371 - Install file integrity monitoring (AIDE)
      tags:
        - stig
        - integrity
        - V-238371
      register: stig_v238371
      ansible.builtin.package:
        name: aide
        state: present
    - name: V-238298 - Install auditd package
      tags:
        - stig
        - audit
        - V-238298
      register: stig_v238298_install
      ansible.builtin.package:
        name: auditd
        state: present
    - name: V-238298 - Enable auditd service
      tags:
        - stig
        - audit
        - V-238298
      register: stig_v238298_service
      ansible.builtin.systemd:
        name: auditd
        enabled: true
        state: started
        daemon_reload: true
    - name: V-238326 - Remove telnet package
      tags:
        - stig
        - telnet
        - V-238326
      register: stig_v238326
      ansible.builtin.package:
        name: telnetd
        state: absent
    - name: V-238327 - Remove rsh-server package
      tags:
        - stig
        - rsh
        - V-238327
      register: stig_v238327
      ansible.builtin.package:
        name: rsh-server
        state: absent
    - name: V-238353 - Install and enable rsyslog
      tags:
        - stig
        - syslog
        - V-238353
      block:
    - name: Install rsyslog
      ansible.builtin.package:
        name: rsyslog
        state: present
    - name: Enable rsyslog service
      ansible.builtin.systemd:
        name: rsyslog
        enabled: true
        state: started
    - name: V-238354 - Install and configure firewall
      tags:
        - stig
        - firewall
        - V-238354
      block:
    - name: Install UFW (Ubuntu/Debian)
      ansible.builtin.package:
        name: ufw
        state: present
        when: ansible_os_family == "Debian"
    - name: Install firewalld (RHEL/CentOS)
      ansible.builtin.package:
        name: firewalld
        state: present
        when: ansible_os_family == "RedHat"
    - name: V-238360 - Install and enable AppArmor
      tags:
        - stig
        - apparmor
        - V-238360
      block:
    - name: Install AppArmor
      ansible.builtin.package:
        name: apparmor
        state: present
        when: ansible_os_family == "Debian"
    - name: Enable AppArmor service
      ansible.builtin.systemd:
        name: apparmor
        enabled: true
        state: started
        when: ansible_os_family == "Debian"
    - name: Install additional security packages
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - packages
      register: stig_additional_packages
      loop:
        - libpam-pwquality
        - chrony
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
    - name: V-238202 - Set minimum password lifetime to 1 day
      tags:
        - stig
        - passwords
        - V-238202
      register: stig_v238202
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: ^PASS_MIN_DAYS
        line: PASS_MIN_DAYS    1
        backup: true
    - name: V-238203 - Set maximum password lifetime to 60 days
      tags:
        - stig
        - passwords
        - V-238203
      register: stig_v238203
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: ^PASS_MAX_DAYS
        line: PASS_MAX_DAYS    60
        backup: true
    - name: V-238207 - Configure session timeout
      tags:
        - stig
        - session
        - V-238207
      register: stig_v238207
      ansible.builtin.copy:
        content: "# MSP STIG V-238207: Session timeout\nTMOUT=600\nreadonly TMOUT\nexport TMOUT\n"
        dest: /etc/profile.d/99-terminal_tmout.sh
        mode: "0644"
        owner: root
        group: root
    - name: V-238208 - Remove NOPASSWD from sudoers
      tags:
        - stig
        - sudo
        - V-238208
      register: stig_v238208
      loop:
        - /etc/sudoers
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: NOPASSWD
        replace: ""
        backup: true
    - name: V-238209 - Set default umask to 077
      tags:
        - stig
        - umask
        - V-238209
      register: stig_v238209
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: ^UMASK
        line: UMASK 077
        backup: true
    - name: V-238211 - Enable SSH PAM authentication
      tags:
        - stig
        - ssh
        - V-238211
      register: stig_v238211
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?UsePAM
        line: UsePAM yes
        backup: true
    - name: V-238212 - Set SSH ClientAliveCountMax to 1
      tags:
        - stig
        - ssh
        - V-238212
      register: stig_v238212
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?ClientAliveCountMax
        line: ClientAliveCountMax 1
        backup: true
    - name: V-238213 - Set SSH ClientAliveInterval to 600
      tags:
        - stig
        - ssh
        - V-238213
      register: stig_v238213
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?ClientAliveInterval
        line: ClientAliveInterval 600
        backup: true
    - name: V-238214 - Configure SSH banner
      tags:
        - stig
        - ssh
        - banner
        - V-238214
      block:
    - name: Create DoD warning banner
      ansible.builtin.copy:
        content: "{{ dod_warning_banner }}"
        dest: /etc/issue.net
        mode: "0644"
        owner: root
        group: root
        backup: true
    - name: Create local issue banner
      ansible.builtin.copy:
        content: "{{ dod_warning_banner }}\n"
        dest: /etc/issue
        mode: "0644"
        owner: root
        group: root
        backup: true
    - name: Configure SSH to use banner
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?Banner
        line: Banner /etc/issue.net
        backup: true
        notify: restart sshd

    - name: V-238216 - Configure SSH MACs
      tags:
        - stig
        - ssh
        - macs
        - V-238216
      register: stig_v238216
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?MACs
        line: MACs hmac-sha2-512,hmac-sha2-256
        backup: true
    - name: V-238218 - Configure SSH security settings
      tags:
        - stig
        - ssh
        - V-238218
      register: stig_v238218
      notify: restart sshd
      loop:
        - regexp: ^#?PermitEmptyPasswords
          line: PermitEmptyPasswords no
        - regexp: ^#?PermitUserEnvironment
          line: PermitUserEnvironment no
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
    - name: V-238219 - Disable SSH X11 forwarding
      tags:
        - stig
        - ssh
        - x11
        - V-238219
      register: stig_v238219
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?X11Forwarding
        line: X11Forwarding no
        backup: true
    - name: V-238220 - Configure SSH X11UseLocalhost
      tags:
        - stig
        - ssh
        - x11
        - V-238220
      register: stig_v238220
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^#?X11UseLocalhost
        line: X11UseLocalhost yes
        backup: true
    - name: V-238221-V-238228 - Configure password complexity
      tags:
        - stig
        - passwords
        - complexity
        - V-238221
        - V-238222
        - V-238223
        - V-238224
        - V-238225
        - V-238226
        - V-238227
        - V-238228
      register: stig_v238221_228
      loop:
        - regexp: ^#?ucredit
          line: ucredit=-1
        - regexp: ^#?lcredit
          line: lcredit=-1
        - regexp: ^#?dcredit
          line: dcredit=-1
        - regexp: ^#?difok
          line: difok=8
        - regexp: ^#?minlen
          line: minlen=15
        - regexp: ^#?ocredit
          line: ocredit=-1
        - regexp: ^#?dictcheck
          line: dictcheck=1
        - regexp: ^#?enforcing
          line: enforcing=1
      ansible.builtin.lineinfile:
        path: /etc/security/pwquality.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
    - name: V-238234 - Configure password history
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - passwords
        - history
        - V-238234
      register: stig_v238234
      ansible.builtin.replace:
        path: /etc/pam.d/common-password
        regexp: ^(password\s+\[success=1\s+default=ignore\]\s+pam_unix\.so).*$
        replace: \1 obscure sha512 shadow remember=5 rounds=5000
        backup: true
    - name: V-238235 - Configure account lockout
      tags:
        - stig
        - passwords
        - lockout
        - V-238235
      register: stig_v238235
      loop:
        - regexp: ^#?audit
          line: audit
        - regexp: ^#?silent
          line: silent
        - regexp: ^#?deny
          line: deny = 3
        - regexp: ^#?fail_interval
          line: fail_interval = 900
        - regexp: ^#?unlock_time
          line: unlock_time = 0
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
    - name: V-238237 - Configure login delay
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - authentication
        - delay
        - V-238237
      register: stig_v238237
      ansible.builtin.replace:
        path: /etc/pam.d/common-auth
        regexp: ^(auth\s+required\s+pam_faildelay\.so).*$
        replace: \1 delay=4000000
        backup: true
    - name: V-238238-V-238242 - Configure file monitoring audit rules
      tags:
        - stig
        - audit
        - files
        - V-238238
        - V-238239
        - V-238240
        - V-238241
        - V-238242
      register: stig_v238238_242
      ansible.builtin.blockinfile:
        path: /etc/audit/rules.d/99-stig-audit.rules
        block: "# File monitoring (V-238238 through V-238242)\n-w /etc/passwd -p wa -k usergroup_modification\n-w /etc/group -p wa -k usergroup_modification\n-w /etc/shadow -p wa -k usergroup_modification\n-w /etc/gshadow -p wa -k usergroup_modification\n-w /etc/security/opasswd -p wa -k usergroup_modification\n"
        marker: "# {mark} STIG FILE MONITORING RULES"
        create: true
        backup: true
    - name: V-238244 - Configure audit failure action
      tags:
        - stig
        - audit
        - failure
        - V-238244
      register: stig_v238244
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: ^#?disk_full_action
        line: disk_full_action = HALT
        backup: true
    - name: V-238245-V-238251 - Configure audit log security
      tags:
        - stig
        - audit
        - permissions
        - V-238245
        - V-238246
        - V-238247
        - V-238248
        - V-238249
        - V-238250
        - V-238251
      block:
    - name: Set audit log file permissions
      ansible.builtin.file:
        path: /var/log/audit
        state: directory
        mode: "0750"
        owner: root
        group: root
        recurse: true
    - name: Set audit log files permissions
      ansible.builtin.shell: |
        find /var/log/audit -type f -exec chmod 0600 {} \;
        find /var/log/audit -type f -exec chown root:root {} \;
        changed_when: false
    - name: Configure audit log group
      ansible.builtin.lineinfile:
        path: /etc/audit/auditd.conf
        regexp: ^#?log_group
        line: log_group = root
        backup: true
    - name: Set audit configuration permissions
      ansible.builtin.shell: |
        chmod 0640 /etc/audit/audit*.{rules,conf} /etc/audit/rules.d/* 2>/dev/null || true
        chown root:root /etc/audit/audit*.{rules,conf} /etc/audit/rules.d/* 2>/dev/null || true
        changed_when: false
    - name: Configure comprehensive audit rules for privileged commands
      tags:
        - stig
        - audit
        - comprehensive
      register: stig_comprehensive_audit
      ansible.builtin.blockinfile:
        path: /etc/audit/rules.d/99-stig-audit.rules
        block: "# Privileged command monitoring\n-a always,exit -F path=/bin/su -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change\n-a always,exit -F path=/usr/bin/chfn -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-chfn\n-a always,exit -F path=/usr/bin/mount -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-mount\n-a always,exit -F path=/usr/bin/umount -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-umount\n-a always,exit -F path=/usr/bin/ssh-agent -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-ssh\n-a always,exit -F path=/usr/lib/openssh/ssh-keysign -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-ssh\n-a always,exit -F path=/usr/bin/sudo -F perm=x -F auid>=1000 -F auid!=4294967295 -k priv_cmd\n-a always,exit -F path=/usr/bin/sudoedit -F perm=x -F auid>=1000 -F auid!=4294967295 -k priv_cmd\n-a always,exit -F path=/usr/bin/chsh -F perm=x -F auid>=1000 -F auid!=4294967295 -k priv_cmd\n-a always,exit -F path=/usr/bin/newgrp -F perm=x -F auid>=1000 -F auid!=4294967295 -k priv_cmd\n-a always,exit -F path=/usr/bin/passwd -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-passwd\n-a always,exit -F path=/usr/bin/gpasswd -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-gpasswd\n-a always,exit -F path=/usr/bin/chage -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-chage\n-a always,exit -F path=/usr/sbin/usermod -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-usermod\n-a always,exit -F path=/usr/bin/crontab -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-crontab\n\n# System call monitoring\n-a always,exit -F arch=b64 -S setxattr,fsetxattr,lsetxattr,removexattr,fremovexattr,lremovexattr -F auid>=1000 -F auid!=-1 -k perm_mod\n-a always,exit -F arch=b32 -S setxattr,fsetxattr,lsetxattr,removexattr,fremovexattr,lremovexattr -F auid>=1000 -F auid!=-1 -k perm_mod\n-a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=4294967295 -k perm_chng\n-a always,exit -F arch=b32 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=4294967295 -k perm_chng\n-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_chng\n-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_chng\n-a always,exit -F arch=b64 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=-1 -k perm_access\n-a always,exit -F arch=b64 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=-1 -k perm_access\n-a always,exit -F arch=b32 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=-1 -k perm_access\n-a always,exit -F arch=b32 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=-1 -k perm_access\n-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=4294967295 -k delete\n-a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=4294967295 -k delete\n-a always,exit -F arch=b64 -S init_module,finit_module -F auid>=1000 -F auid!=4294967295 -k module_chng\n-a always,exit -F arch=b32 -S init_module,finit_module -F auid>=1000 -F auid!=4294967295 -k module_chng\n-a always,exit -F arch=b64 -S delete_module -F auid>=1000 -F auid!=4294967295 -k module_chng\n-a always,exit -F arch=b32 -S delete_module -F auid>=1000 -F auid!=4294967295 -k module_chng\n-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -F key=execpriv\n-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -F key=execpriv\n-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -F key=execpriv\n-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -F key=execpriv\n\n# Log file monitoring\n-w /var/log/tallylog -p wa -k logins\n-w /var/log/faillog -p wa -k logins\n-w /var/log/lastlog -p wa -k logins\n-w /var/log/wtmp -p wa -k logins\n-w /var/run/wtmp -p wa -k logins\n-w /var/log/btmp -p wa -k logins\n-w /var/log/sudo.log -p wa -k maintenance\n\n# Module monitoring\n-w /sbin/modprobe -p x -k modules\n-w /bin/kmod -p x -k modules\n-w /usr/sbin/fdisk -p x -k fdisk\n"
        marker: "# {mark} STIG COMPREHENSIVE AUDIT RULES"
        backup: true
    - name: V-238299 - Enable audit at boot
      tags:
        - stig
        - boot
        - audit
        - V-238299
      register: stig_v238299
      notify: update grub
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: ^GRUB_CMDLINE_LINUX=
        line: GRUB_CMDLINE_LINUX="audit=1"
        backup: true
    - name: V-238300-V-238303 - Secure audit tools
      tags:
        - stig
        - audit
        - tools
        - V-238300
        - V-238301
        - V-238302
        - V-238303
      block:
    - name: Set audit tools permissions
      ansible.builtin.file:
        path: /sbin/{{ item }}
        mode: "0755"
        owner: root
        group: root
      loop:
        - auditctl
        - auditd
        - ausearch
        - aureport
        - autrace
        - audispd
        - augenrules
      failed_when: false
    - name: Configure AIDE for audit tools
      ansible.builtin.blockinfile:
        path: /etc/aide/aide.conf
        block: "# STIG V-238303: Audit tools integrity\n/sbin/auditctl p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/auditd p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/ausearch p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/aureport p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/autrace p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/audispd p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/augenrules p+i+n+u+g+s+b+acl+xattrs+sha512\n"
        marker: "# {mark} STIG AUDIT TOOLS AIDE CONFIG"
        create: true
        backup: true

    - name: V-238308 - Set timezone to UTC
      tags:
        - stig
        - time
        - V-238308
      register: stig_v238308
      community.general.timezone:
        name: UTC
    - name: V-238323 - Configure session limits
      tags:
        - stig
        - sessions
        - V-238323
      register: stig_v238323
      ansible.builtin.lineinfile:
        path: /etc/security/limits.conf
        line: "* hard maxlogins 10"
        backup: true
    - name: V-238324 - Configure remote access monitoring
      tags:
        - stig
        - monitoring
        - V-238324
      register: stig_v238324
      loop:
        - auth.*,authpriv.* /var/log/secure
        - daemon.* /var/log/messages
      ansible.builtin.lineinfile:
        path: /etc/rsyslog.d/50-default.conf
        line: "{{ item }}"
        backup: true
    - name: V-238325 - Configure password encryption
      tags:
        - stig
        - passwords
        - encryption
        - V-238325
      register: stig_v238325
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: ^#?ENCRYPT_METHOD
        line: ENCRYPT_METHOD SHA512
        backup: true
    - name: V-238328 - Configure firewall rules
      tags:
        - stig
        - firewall
        - V-238328
      block:
    - name: Configure UFW (Ubuntu/Debian)
      when: ansible_os_family == "Debian"
      block:
    - name: Set UFW defaults
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }
    - name: Allow SSH
      community.general.ufw:
        rule: allow
        name: OpenSSH
    - name: Enable UFW
      community.general.ufw:
        state: enabled
    - name: Configure firewalld (RHEL/CentOS)
      when: ansible_os_family == "RedHat"
      block:
    - name: Start and enable firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: started
        enabled: true
    - name: Allow SSH through firewalld
      ansible.posix.firewalld:
        service: ssh
        permanent: true
        state: enabled
        immediate: true
    - name: V-238329 - Lock root account
      tags:
        - stig
        - root
        - V-238329
      register: stig_v238329
      ansible.builtin.user:
        name: root
        password_lock: true
    - name: V-238332 - Set sticky bit on public directories
      tags:
        - stig
        - directories
        - V-238332
      register: stig_v238332
      changed_when: false
      ansible.builtin.shell: |
        set -o pipefail
        find / -type d -perm -002 ! -perm -1000 -exec chmod +t '{}' \; 2>/dev/null || true
    - name: V-238333 - Enable TCP syncookies
      tags:
        - stig
        - network
        - V-238333
      register: stig_v238333
      ansible.posix.sysctl:
        name: net.ipv4.tcp_syncookies
        value: "1"
        state: present
        reload: true
        sysctl_file: /etc/sysctl.d/99-stig.conf
    - name: V-238334 - Disable kdump service
      tags:
        - stig
        - kdump
        - V-238334
      register: stig_v238334
      failed_when: false
      ansible.builtin.systemd:
        name: kdump
        enabled: false
        state: stopped
    - name: V-238337-V-238352 - Configure log security
      tags:
        - stig
        - permissions
        - V-238337
        - V-238338
        - V-238339
        - V-238340
        - V-238341
        - V-238342
        - V-238343
        - V-238344
        - V-238345
        - V-238346
        - V-238347
        - V-238348
        - V-238349
        - V-238350
        - V-238351
        - V-238352
      block:
    - name: Set log file permissions
      ansible.builtin.shell: |
        find /var/log -perm /137 -type f -exec chmod 640 '{}' \; 2>/dev/null || true
    - name: Configure /var/log directory
      ansible.builtin.file:
        path: /var/log
        state: directory
        mode: "0750"
        owner: root
        group: syslog
    - name: Configure /var/log/syslog
      ansible.builtin.file:
        path: /var/log/syslog
        mode: "0640"
        owner: syslog
        group: adm
        failed_when: false
    - name: Secure system command directories
      ansible.builtin.shell: |
        find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -perm /022 -type d -exec chmod 755 '{}' \; 2>/dev/null || true
        find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -user root -type d -exec chown root '{}' \; 2>/dev/null || true
        find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -group root -type d -exec chgrp root '{}' \; 2>/dev/null || true
    - name: Secure library files and directories
      ansible.builtin.shell: |
        find /lib /lib64 /usr/lib -perm /022 -type f -exec chmod 755 '{}' \; 2>/dev/null || true
        find /lib /lib64 /usr/lib -perm /022 -type d -exec chmod 755 '{}' \; 2>/dev/null || true
        find /lib /usr/lib /lib64 ! -user root -type f -exec chown root '{}' \; 2>/dev/null || true
        find /lib /usr/lib /lib64 ! -user root -type d -exec chown root '{}' \; 2>/dev/null || true
        find /lib /usr/lib /lib64 ! -group root -type f -exec chgrp root '{}' \; 2>/dev/null || true
        find /lib /usr/lib /lib64 ! -group root -type d -exec chgrp root '{}' \; 2>/dev/null || true
    - name: Secure system commands
      ansible.builtin.shell: |
        find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -perm /022 -type f -exec chmod 755 '{}' \; 2>/dev/null || true
        find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -user root -type f -exec chown root '{}' \; 2>/dev/null || true
        find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -group root -type f ! -perm /2000 -exec chgrp root '{}' \; 2>/dev/null || true
        changed_when: false
    - name: V-238356 - Configure time synchronization
      tags:
        - stig
        - time
        - V-238356
      block:
    - name: Configure chrony
      ansible.builtin.copy:
        content: "# STIG V-238356: Time synchronization\nserver tick.usno.navy.mil iburst maxpoll 16\nserver tock.usno.navy.mil iburst maxpoll 16\nserver ntp2.usno.navy.mil iburst maxpoll 16\ndriftfile /var/lib/chrony/drift\nmakestep 1.0 3\nrtcsync\nlogdir /var/log/chrony\n"
        dest: /etc/chrony/chrony.conf
        backup: true
        when: ansible_os_family == "Debian"
    - name: Configure chrony daemon options
      ansible.builtin.lineinfile:
        path: /etc/default/chrony
        regexp: ^#?DAEMON_OPTS
        line: DAEMON_OPTS="-R -F -1"
        backup: true
        when: ansible_os_family == "Debian"

    - name: V-238358 - Configure AIDE reporting
      tags:
        - stig
        - aide
        - V-238358
      register: stig_v238358
      ansible.builtin.lineinfile:
        path: /etc/default/aide
        regexp: ^#?SILENTREPORTS
        line: SILENTREPORTS=no
        backup: true
    - name: V-238359 - Remove APT unauthenticated packages
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - apt
        - V-238359
      register: stig_v238359
      changed_when: false
      ansible.builtin.shell: |
        set -o pipefail
        find /etc/apt/apt.conf.d/ -name "*.conf" -exec sed -i '/AllowUnauthenticated/d' {} \;
    - name: V-238369 - Configure ASLR
      tags:
        - stig
        - aslr
        - V-238369
      register: stig_v238369
      ansible.posix.sysctl:
        name: kernel.randomize_va_space
        value: "2"
        state: present
        reload: true
        sysctl_file: /etc/sysctl.d/99-stig.conf
    - name: V-238370 - Configure APT cleanup
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - apt
        - cleanup
        - V-238370
      register: stig_v238370
      loop:
        - Unattended-Upgrade::Remove-Unused-Dependencies "true";
        - Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      ansible.builtin.lineinfile:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
        line: "{{ item }}"
        backup: true
    - name: V-238373 - Configure last login display
      tags:
        - stig
        - login
        - V-238373
      register: stig_v238373
      ansible.builtin.replace:
        path: /etc/pam.d/login
        regexp: ^(session\s+required\s+pam_lastlog\.so).*$
        replace: \1 showfailed
        backup: true
    - name: V-238380 - Disable Ctrl-Alt-Delete
      tags:
        - stig
        - system
        - V-238380
      block:
    - name: Disable ctrl-alt-del target
      ansible.builtin.systemd:
        name: ctrl-alt-del.target
        enabled: false
        masked: true
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: V-251504 - Remove null password option
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - passwords
        - V-251504
      register: stig_v251504
      ansible.builtin.replace:
        path: /etc/pam.d/common-password
        regexp: nullok
        replace: ""
        backup: true
    - name: V-251505 - Disable USB mass storage
      tags:
        - stig
        - usb
        - V-251505
      register: stig_v251505
      ansible.builtin.blockinfile:
        path: /etc/modprobe.d/DISASTIG.conf
        block: "# STIG V-251505: Disable USB mass storage\ninstall usb-storage /bin/true\nblacklist usb-storage\n"
        marker: "# {mark} STIG USB STORAGE DISABLE"
        create: true
        backup: true
    - name: Initialize AIDE database
      when: ansible_os_family == "Debian"
      tags:
        - stig
        - aide
        - initialization
      register: stig_aide_init
      changed_when: false
      failed_when: false
      ansible.builtin.shell: |
        cd /tmp
        apt download aide-common 2>/dev/null || true
        dpkg-deb --fsys-tarfile aide-common_*.deb | tar -x ./usr/share/aide/config/cron.daily/aide -C / 2>/dev/null || true
        cp -f /usr/share/aide/config/cron.daily/aide /etc/cron.daily/aide 2>/dev/null || true
        aideinit --yes --config-check 2>/dev/null || true
  post_tasks:
    - name: Collect all STIG findings
      tags:
        - reporting
      loop:
        - rule: V-238200
          status: "{{ 'FIXED' if stig_v238200.changed else 'COMPLIANT' }}"
          description: Session lock capability installed
        - rule: V-238371
          status: "{{ 'FIXED' if stig_v238371.changed else 'COMPLIANT' }}"
          description: AIDE file integrity tool installed
        - rule: V-238298
          status: "{{ 'FIXED' if (stig_v238298_install.changed or stig_v238298_service.changed) else 'COMPLIANT' }}"
          description: Audit daemon installed and enabled
        - rule: V-238202
          status: "{{ 'FIXED' if stig_v238202.changed else 'COMPLIANT' }}"
          description: Minimum password lifetime configured
        - rule: V-238203
          status: "{{ 'FIXED' if stig_v238203.changed else 'COMPLIANT' }}"
          description: Maximum password lifetime configured
        - rule: V-238214
          status: "{{ 'FIXED' if stig_v238214.changed else 'COMPLIANT' }}"
          description: DoD warning banner configured
        - rule: V-238299
          status: "{{ 'FIXED' if stig_v238299.changed else 'COMPLIANT' }}"
          description: Boot audit enabled
        - rule: V-238328
          status: "{{ 'FIXED' if stig_v238328.changed else 'COMPLIANT' }}"
          description: Firewall configured
        - rule: V-238329
          status: "{{ 'FIXED' if stig_v238329.changed else 'COMPLIANT' }}"
          description: Root account locked
        - rule: V-238380
          status: "{{ 'FIXED' if stig_v238380.changed else 'COMPLIANT' }}"
          description: Ctrl-Alt-Delete disabled
      ansible.builtin.set_fact:
        stig_findings: "{{ stig_findings + [item] }}"
    - name: Generate comprehensive STIG compliance report
      tags:
        - reporting
      vars:
        total_controls: "{{ stig_findings | length }}"
        fixed_controls: "{{ stig_findings | selectattr('status', 'equalto', 'FIXED') | list | length }}"
        compliant_controls: "{{ stig_findings | selectattr('status', 'equalto', 'COMPLIANT') | list | length }}"
        failed_controls: "{{ stig_findings | selectattr('status', 'equalto', 'FAILED') | list | length }}"
        compliance_percentage: "{{ ((fixed_controls + compliant_controls) / total_controls * 100) | round(2) }}"
      ansible.builtin.template:
        src: stig_enhanced_report.j2
        dest: /var/log/msp/{{ client_name }}/stig-enhanced/reports/enhanced-stig-report-{{ stig_session_id }}.json
        mode: "0640"
    - name: Restart critical services
      tags:
        - services
      failed_when: false
      loop:
        - auditd
        - rsyslog
        - chrony
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
        daemon_reload: true
    - name: Reload audit rules
      tags:
        - audit
      register: audit_reload
      failed_when: false
      ansible.builtin.shell: |
        set -o pipefail
        augenrules --load
    - name: Final STIG compliance summary
      tags:
        - summary
      ansible.builtin.debug:
        msg: "🔒 Enhanced STIG Compliance Complete for {{ client_name }}\n================================================\nTotal Controls: {{ stig_findings | length }}\nFixed: {{ stig_findings | selectattr('status', 'equalto', 'FIXED') | list | length }}\nCompliant: {{ stig_findings | selectattr('status', 'equalto', 'COMPLIANT') | list | length }}\nFailed: {{ stig_findings | selectattr('status', 'equalto', 'FAILED') | list | length }}\nCompliance: {{ ((stig_findings | selectattr('status', 'in', ['FIXED', 'COMPLIANT']) | list | length) / stig_findings | length * 100) | round(2) }}%\n\nReport: /var/log/msp/{{ client_name }}/stig-enhanced/reports/enhanced-stig-report-{{ stig_session_id }}.json\n"
  handlers:
    - name: restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted
    - name: restart auditd
      ansible.builtin.systemd:
        name: auditd
        state: restarted
    - name: reload auditd
      ansible.builtin.systemd:
        name: auditd
        state: reloaded
    - name: update grub
      when: ansible_os_family == "Debian"
      ansible.builtin.command: update-grub
